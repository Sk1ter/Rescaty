package pe.edu.certus.rescatyfrontend.cliente;

import jakarta.servlet.http.HttpSession;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestClient;
import pe.edu.certus.rescatyfrontend.dto.UsuarioSesion;
import pe.edu.certus.rescatyfrontend.modelo.SolicitudAdopcion;

import java.util.Arrays;
import java.util.List;
import java.util.Map;

@Component
public class SolicitudAdopcionApiCliente {

    private static final String BASE_URL = "http://localhost:8080/api/adopciones";
    private final RestClient restClient;

    public SolicitudAdopcionApiCliente(HttpSession session) {

        this.restClient = RestClient.builder()
                .requestInterceptor((request, body, execution) -> {

                    UsuarioSesion user = (UsuarioSesion) session.getAttribute("usuarioSesion");

                    if (user != null && user.getToken() != null) {
                        request.getHeaders().add("Authorization", "Bearer " + user.getToken());
                    }

                    return execution.execute(request, body);
                })
                .build();
    }

    public SolicitudAdopcion crearSolicitud(SolicitudAdopcion solicitud) {
        return restClient.post()
                .uri(BASE_URL)
                .body(solicitud)
                .retrieve()
                .body(SolicitudAdopcion.class);
    }

    public List<SolicitudAdopcion> listarSolicitudes() {
        SolicitudAdopcion[] arr = restClient.get()
                .uri(BASE_URL)
                .retrieve()
                .body(SolicitudAdopcion[].class);

        return Arrays.asList(arr);
    }

    public SolicitudAdopcion obtenerSolicitud(Long id) {
        return restClient.get()
                .uri(BASE_URL + "/" + id)
                .retrieve()
                .body(SolicitudAdopcion.class);
    }

    public List<SolicitudAdopcion> listarPorUsuario(Long userId) {

        SolicitudAdopcion[] arr = restClient.get()
                .uri(BASE_URL + "/usuario/" + userId)
                .retrieve()
                .body(SolicitudAdopcion[].class);

        return Arrays.asList(arr);
    }

    public Map<String, String> actualizarEstado(Long id, String nuevoEstado) {

        return restClient.put()
                .uri(BASE_URL + "/" + id + "/estado")
                .body(Map.of("estado", nuevoEstado))
                .retrieve()
                .body(Map.class);
    }

    public void eliminarSolicitud(Long id) {
        restClient.delete()
                .uri(BASE_URL + "/" + id)
                .retrieve()
                .body(String.class);
    }
}
