package pe.edu.certus.rescatyfrontend.controller;

import jakarta.servlet.http.HttpSession;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import pe.edu.certus.rescatyfrontend.cliente.MascotaApiCliente;
import pe.edu.certus.rescatyfrontend.dto.UsuarioSesion;
import pe.edu.certus.rescatyfrontend.modelo.Mascota;

@Controller
@RequestMapping("/mascotas")
public class MascotaController {

    private final MascotaApiCliente api;

    public MascotaController(MascotaApiCliente api) {
        this.api = api;
    }

    @GetMapping
    public String listarMascotas(HttpSession session, Model model) {

        UsuarioSesion user = (UsuarioSesion) session.getAttribute("usuarioSesion");
        if (user == null) {
            return "redirect:/";
        }

        model.addAttribute("user", user);
        model.addAttribute("mascotas", api.listarMascotas());

        return "mascotas";   // mascotas.html
    }

    @PostMapping("/crear")
    public String crearMascota(Mascota mascota) {
        api.crearMascota(mascota);
        return "redirect:/mascotas";
    }

    @GetMapping("/editar/{id}")
    public String mostrarEditar(@PathVariable Long id,
                                HttpSession session,
                                Model model) {

        UsuarioSesion user = (UsuarioSesion) session.getAttribute("usuarioSesion");
        if (user == null) {
            return "redirect:/";
        }

        model.addAttribute("user", user);
        model.addAttribute("mascotas", api.listarMascotas());

        Mascota mascota = api.obtenerMascota(id);
        model.addAttribute("mascotaEdit", mascota);
        model.addAttribute("abrirModalEditarMascota", true);

        return "mascotas";
    }

    @PostMapping("/editar/{id}")
    public String editarMascota(@PathVariable Long id, Mascota mascota) {
        api.actualizarMascota(id, mascota);
        return "redirect:/mascotas";
    }

    @PostMapping("/eliminar/{id}")
    public String eliminarMascota(@PathVariable Long id) {
        api.eliminarMascota(id);
        return "redirect:/mascotas";
    }
}
